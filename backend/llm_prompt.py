import os
from dotenv import load_dotenv
from langchain_upstage import ChatUpstage
from langchain.prompts import ChatPromptTemplate
from langchain.schema.output_parser import StrOutputParser
from rag import RAGPipeline

load_dotenv()


class LLMPipeline:
    def __init__(self):
        self.api_key = os.getenv("UPSTAGE_API_KEY")
        if not self.api_key:
            raise ValueError("UPSTAGE_API_KEYê°€ .env íŒŒì¼ì— ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

        self.llm = ChatUpstage(
            api_key=self.api_key,  # type: ignore
            model="solar-pro2",
            temperature=0.1,
        )

        self.rag = RAGPipeline()

        self.relevant_docs = []

        self.chain = self._create_chain()

    def _create_chain(self):
        """LLM ì²´ì¸ ìƒì„±"""
        template = """
ë‹¹ì‹ ì€ 20ëŒ€ í•™ìƒë“¤ì—ê²Œ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•™ìŠµ ì»¨ì„¤íŒ…ì„ í•´ì£¼ëŠ” ì „ë¬¸ ìƒë‹´ì›ì…ë‹ˆë‹¤. ì£¼ ëª©í‘œëŠ” í•™ìƒë“¤ì´ {topic}ì˜ í•™ìŠµ ëª©í‘œë¥¼ íš¨ê³¼ì ìœ¼ë¡œ ë‹¬ì„±í•  ìˆ˜ ìˆë„ë¡ í•™ìŠµ ì§‘ì¤‘ë„/ëª°ì…ë„ì™€ ê´€ë ¨ëœ í”¼ë“œë°±ì„ ì œê³µí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

**GUIDELINES:**
1. 20ëŒ€ ëŒ€í•™ìƒë“¤ì—ê²Œ ì í•©í•œ ë§íˆ¬, ì¹œê·¼í•œ ë§íˆ¬ë¥¼ ì‚¬ìš©í•  ê²ƒ.
2. **ì—†ëŠ” ì‚¬ì‹¤ì„ ë§Œë“¤ì–´ë‚´ì§€ ì•Šê³ ** ë°›ì€ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ì—¬ ê·¼ê±° ìœ„ì£¼ì˜ ìƒë‹´ì„ ì§„í–‰í•  ê²ƒ.
3. **í™•ì‹¤í•˜ì§€ ì•ŠëŠ” ì‚¬ì‹¤ì€ ì¶”ë¡ í•˜ì§€ ì•Šì„ ê²ƒ**
4. ë°›ì€ ë°ì´í„°ì˜ ëª¨ë“  ì—´ì„ ì¶©ë¶„íˆ í™œìš©í•˜ê³  ê·¼ê±°ìˆëŠ” ì„¤ëª…ì„ ë§Œë“¤ê¸° ìœ„í•´ ì§€ì†ì ìœ¼ë¡œ ìƒê°í•  ê²ƒ.
5. ë¶€ì¡±í•œ ë¶€ë¶„ì€ í™•ì‹¤í•˜ê²Œ ì§šì–´ì£¼ê³ , ë™ê¸°ê°€ ìƒê¸¸ ìˆ˜ ìˆê²Œ ê²©ë ¤ ìœ„ì£¼ë¡œ ìƒë‹´í•  ê²ƒ.
6. ê° í”¼ë“œë°± ë‹¹ **ì˜ˆì‹œë¥¼ ì°¸ê³ **í•˜ì—¬ 5-6ë¬¸ì¥ ì •ë„ë¡œ ì‘ì„±í•  ê²ƒ.
7. í”¼ë“œë°±ì„ **ë§ˆí¬ë‹¤ìš´ í˜•ì‹**ìœ¼ë¡œ ì¨ì¤˜. ê° í•­ëª©ì€ êµµì€ ì œëª©ê³¼ ì¤„ë°”ê¿ˆì„ í¬í•¨í•´ì„œ êµ¬ì„±í•´ì¤˜.

**DATA:**
{data}

**RAG:**
{rag}

**DATA INFO:**
- 'start_time': í•™ìŠµ ì‹œì‘ ì‹œê°„
- 'concentration': ì§‘ì¤‘ë„ ë¶„ë¥˜ ì˜ˆì¸¡
- 'pose_yaw': ì¢Œìš° ì‹œì„ (ìŒìˆ˜:ì˜¤ë¥¸ìª½, ì–‘ìˆ˜:ì™¼ìª½)
- 'pose_pitch': ìƒí•˜ ì‹œì„ (ìŒìˆ˜:ì•„ë˜ìª½, ì–‘ìˆ˜:ìœ„ìª½)
- 'noise': ì¡ìŒ ì˜ˆì¸¡ ê²°ê³¼

**RAG INFO:**
- [[[[ì£¼ì œì–´, êµì¬ í˜ì´ì§€], [ì£¼ì œì–´2, êµì¬ í˜ì´ì§€2], ...], ì§‘ì¤‘ì—¬ë¶€], ...]

**í”¼ë“œë°± 1. "ì–¸ì œ" ì§‘ì¤‘ë„ê°€ ë†’ì•˜ëŠ”ì§€/ë‚®ì•˜ëŠ”ì§€ì— ëŒ€í•œ í”¼ë“œë°±**
- DATAì˜ 'start_time'ì„ ê¸°ì¤€ìœ¼ë¡œ ì‹œê°„ì— ë”°ë¥¸ ëª°ì…ë„/ì§‘ì¤‘ë„ í”¼ë“œë°±
- 'start_time'ì˜ ì´ˆë‹¨ìœ„ë¥¼ ì‹œê°„/ë¶„ ë‹¨ìœ„ë¡œ ë³€í™˜í•˜ì—¬ ì„¤ëª…
- ëª°ì…ë„ ì˜ˆì¸¡ ê²°ê³¼ë¥¼ ê°€ì¥ ì¤‘ì‹œí•˜ë˜, ì‹œì„  ì²˜ë¦¬, ì¡ìŒ ì˜ˆì¸¡ ê²°ê³¼ ë“±ì„ ë¶€ê°€ì ìœ¼ë¡œ ì¢…í•©í•˜ì—¬ ì¹­ì°¬í•  ì ê³¼ ê°œì„ í•  ì  ì–¸ê¸‰
- **ì˜ˆì‹œ:** ë„ˆì˜ í•™ìŠµ íŒ¨í„´ì„ ì‚´í´ë³¸ ê²°ê³¼, í•™ìŠµ ì´ˆë°˜ì—ëŠ” ì˜ ì§‘ì¤‘í•˜ëŠ” ê²ƒ ê°™ì•„. ì•„ì£¼ ì¹­ì°¬í•´^^ ë‹¤ë§Œ ì‹œê°„ì´ ì§€ë‚¨ì— ë”°ë¼ì„œ ì ì°¨ ì§‘ì¤‘ë„ê°€ ë‚®ì•„ì§„ ëª¨ìŠµì´ ë³´ì—¬. íŠ¹íˆ ì‹œì„ ë„ ì¢Œìš°ë¡œ ì¡°ê¸ˆ ë¶„ì‚°ë˜ëŠ” ê²ƒ ê°™ì•„. ë˜, ì‹¸ì´ë Œ ì†Œë¦¬ì— ì˜ˆë¯¼í•œ ê²ƒ ê°™ì•„. ë‹¤ìŒì— ê³µë¶€í•  ë•ŒëŠ” ì´ ì  ì‹ ê²½ì¨ì„œ ë§ˆì§€ë§‰ê¹Œì§€ í•¨ê»˜ ì§‘ì¤‘í•´ë³´ë„ë¡ ë…¸ë ¥í•´ë³´ì~

**í”¼ë“œë°± 2. "ì–´ë–¤ í•™ìŠµ ì‹œì—" ì§‘ì¤‘ë„ê°€ ë†’ì•˜ëŠ”ì§€/ë‚®ì•˜ëŠ”ì§€ì— ëŒ€í•œ í”¼ë“œë°±**
- RAGë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•™ìŠµ ì£¼ì œì— ë”°ë¥¸ ëª°ì…ë„/ì§‘ì¤‘ë„ í”¼ë“œë°±
- ì§‘ì¤‘ë„ê°€ ë‚®ì€ ì£¼ì œëŠ” êµì¬ í˜ì´ì§€ë¥¼ ì–¸ê¸‰í•˜ë©´ì„œ í”¼ë“œë°± ì§„í–‰
- **ì˜ˆì‹œ:** ê±°ë˜ì²˜ë¦¬ì‹œìŠ¤í…œ(Transaction Processing Systems) ê³µë¶€í•  ë•ŒëŠ” ì—„ì²­ ì§‘ì¤‘í•˜ê³  ìˆì—ˆì–´. ì •ë§ ì—´ì‹¬íˆ í•œë‹¤~ ë°˜ë©´ ì „ë¬¸ê°€ ì‹œìŠ¤í…œ(Expert Systems)ì—ì„œ ì§‘ì¤‘ë„ê°€ ë§ì´ ë–¨ì–´ì¡Œì—ˆë„¤â€¦ ì´ ë¶€ë¶„ì€ êµì¬ì˜ ~~ë¥¼ ë³´ë©´ì„œ ë‹¤ì‹œ ì²´í¬í•´ë³´ë©´ ì¢‹ì„ ê²ƒ ê°™ì•„!

**í”¼ë“œë°± 3. ìµœì¢…ì •ë¦¬**
- ê³¼ê±° ìƒì„±í•œ í”¼ë“œë°±ì„ ì°¸ê³ í•  ê²ƒ.
- í”¼ë“œë°± 1ê³¼ í”¼ë“œë°± 2ì˜ ì „ë°˜ì ì¸ íë¦„ì„ ì œëŒ€ë¡œ ì •í™•í•˜ê²Œ ì•Œë ¤ì¤„ ê²ƒ
- **ì˜ˆì‹œ:** ê³µë¶€í•˜ëŠ” ëª¨ìŠµì´ë‚˜ ì‹œì„ , ì£¼ë³€ í™˜ê²½ ë“±ì„ ì¢…í•©í•´ë³´ì•˜ì„ ë•Œ ì§€ê¸ˆ ë§¤ìš° ì˜í•˜ê³  ìˆë‹¤ê³  ìƒê°ì´ ë“¤ì–´! ì¡ìŒì´ ìˆì„ ë•Œë„ ì§‘ì¤‘í•˜ëŠ” ëª¨ìŠµì„ ë§ì´ ë³´ì—¬ ì¤¬ê³ , ì‹œì„ ë„ ê°•ì˜ì— ì§‘ì¤‘ì„ ì˜í•˜ê³  ìˆì—ˆë˜ ê²ƒ ê°™ì•„~ ì•„ì£¼ ì¹­ì°¬í•´^^ í•˜ì§€ë§Œ ëª‡ ê°€ì§€ ê°™ì´ ë‹¤ë“¬ì–´ê°€ë©´ ì¢‹ì„ ë¶€ë¶„ì€ ì‹œê°„ì— ë”°ë¼ ì ì°¨ ì§‘ì¤‘ë„ê°€ ë–¨ì–´ì§€ëŠ” ë¶€ë¶„ì´ì•¼. ë§ˆì§€ë§‰ê¹Œì§€ ë§ˆìŒì„ ë‹¤ì¡ê³  ê°™ì´ ëê¹Œì§€ í•´ë³´ì! ê·¸ë¦¬ê³  ì „ë¬¸ê°€ ì‹œìŠ¤í…œì„ ì´í•´í•˜ëŠ” ê²ƒì— ì–´ë ¤ì›€ì„ ê²ªëŠ” ê²ƒ ê°™ì•„. í˜¹ì‹œ ì´ ë¶€ë¶„ì— ê¶ê¸ˆí•œ ì  ìˆì–´? ìˆìœ¼ë©´ ê°™ì´ í•´ê²°í•´ë‚˜ê°€ë³´ì!

**í”¼ë“œë°± 4. ì¶”ì²œ ì „ëµ**
- ìµœì¢…ì •ë¦¬ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•™ìŠµ ì „ëµ ì œì‹œ
- ê³¼ê±° ìƒì„±í•œ í”¼ë“œë°±ì„ ì°¸ê³ í•  ê²ƒ.

**ì¶œë ¥ êµ¬ì¡°**
âœ… í”¼ë“œë°± 1. í•™ìŠµ íƒœë„ í”¼ë“œë°±
...

â˜‘ï¸ í”¼ë“œë°± 2. í•™ìŠµ ë‚´ìš© í”¼ë“œë°±
...

ğŸ“š ìµœì¢…ì •ë¦¬
...

ğŸ’¡ ì¶”ì²œì „ëµ
...
"""
        prompt = ChatPromptTemplate.from_template(template)
        return prompt | self.llm | StrOutputParser()

    def _rag_process(self, topic: str, stt_chunk: list) -> str:
        """
        RAG ì§„í–‰ [OPTIMIZED]
        """
        result = []

        # í…ìŠ¤íŠ¸ ê·¸ë£¹í™”
        focused_texts = " ".join(
            [text for text, state in stt_chunk if state == "ì§‘ì¤‘" and text.strip()]
        )
        unfocused_texts = " ".join(
            [text for text, state in stt_chunk if state == "ì§‘ì¤‘ ëª»í•¨" and text.strip()]
        )

        # ì§‘ì¤‘ êµ¬ê°„ RAG
        if focused_texts:
            rag_output = self.rag.ask_question(focused_texts, topic)
            topic_output = rag_output["answer"]
            if topic_output and topic_output[0][0] != "":
                result.append([topic_output, "ì§‘ì¤‘"])
            self.relevant_docs.extend(rag_output["relevant_docs"])

        # ë¹„ì§‘ì¤‘ êµ¬ê°„ RAG
        if unfocused_texts:
            rag_output = self.rag.ask_question(unfocused_texts, topic)
            topic_output = rag_output["answer"]
            if topic_output and topic_output[0][0] != "":
                result.append([topic_output, "ì§‘ì¤‘ ëª»í•¨"])
            self.relevant_docs.extend(rag_output["relevant_docs"])

        return str(result)

    def print_report(self, topic: str, data: str, stt_chunk: list):
        """
        ë¦¬í¬íŠ¸ ìƒì„±
        """
        try:
            print("ğŸš€ LLM ë¦¬í¬íŠ¸ ìƒì„± ì¤‘...")
            rag = self._rag_process(topic, stt_chunk)

            answer = self.chain.invoke({"topic": topic, "data": data, "rag": rag})

        except Exception as e:
            print(f"ë‹µë³€ ìƒì„± ì‹¤íŒ¨: {str(e)}")
            return None
        return answer
